// Supabase Edge Runtime 타입 선언 (에디터 자동완성/타입 체크 개선용)
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
// ⚠️ recommendation.ts가 default export인지 확인하세요.
// default export가 아니라면 아래를 -> `import { CropRecommendationEngine } from "./recommendation.ts";` 로 바꾸세요.
import CropRecommendationEngine from "./recommendation.ts";
const cors = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
  "Access-Control-Allow-Headers": "authorization, Authorization, x-client-info, apikey, content-type"
};
function json(data, init = {}) {
  return new Response(JSON.stringify(data, null, 2), {
    headers: {
      "content-type": "application/json; charset=utf-8",
      "content-encoding": "utf-8",
      ...cors,
      ...init.headers || {}
    },
    status: init.status ?? 200
  });
}
Deno.serve(async (req)=>{
  console.log("🚀 요청 받음:", req.method, req.url);
  // 맨 위 근처에 로깅 추가(원인 파악 편의)
  const { method } = req;
  const url = new URL(req.url);
  console.log("➡️ method:", method, "path:", url.pathname);
  // 0) CORS preflight
  if (method === "OPTIONS") {
    return new Response(null, {
      status: 204,
      headers: cors
    });
  }
  // 1) 헬스체크 (GET / 또는 GET /favicon.ico)
  if (method === "GET" && (url.pathname === "/" || url.pathname === "/favicon.ico")) {
  // ... 기존 헬스체크 응답
  }
  // 2) 실제 엔드포인트: POST면 경로 허용 폭을 넓힘
  const pathOk = url.pathname === "/" || url.pathname.endsWith("/recommend") || // /recommend
  url.pathname.endsWith("/functions/v1/recommend"); // /functions/v1/recommend (일부 환경)
  if (method !== "POST" || !pathOk) {
    console.log("❌ 잘못된 요청:", method, url.pathname);
    return json({
      error: "Not Found"
    }, {
      status: 404
    });
  }
  try {
    // --- 요청 파싱 ---
    let body = {};
    try {
      body = await req.json();
    } catch  {
      body = {};
    }
    // 두 가지 키 네이밍 모두 허용: input_* 또는 단순 이름
    const start_month = body.start_month ?? body?.startMonth;
    const end_month = body.end_month ?? body?.endMonth;
    const place = body.input_place ?? body.place;
    const irang = body.input_irang ?? body.irang;
    if (typeof start_month !== "number" || typeof end_month !== "number" || typeof place !== "string" || typeof irang !== "number") {
      return json({
        error: "Invalid payload"
      }, {
        status: 400
      });
    }
    // --- Supabase 클라이언트 ---
    const supabaseUrl = Deno.env.get("SUPABASE_URL") ?? "";
    const supabaseKey = Deno.env.get("SUPABASE_ANON_KEY") ?? "";
    if (!supabaseUrl || !supabaseKey) {
      return json({
        error: "SUPABASE_URL / SUPABASE_ANON_KEY not set"
      }, {
        status: 500
      });
    }
    // ✅ 호출자 권한으로 RLS 평가되도록 헤더 주입
    const supabase = createClient(supabaseUrl, supabaseKey, {
      global: {
        headers: {
          Authorization: req.headers.get("Authorization") ?? ""
        }
      }
    });
    // --- 데이터 조회 ---
    console.log("🔍 데이터베이스에서 작물 데이터 조회 중...");
    let { data: cropsData, error } = await supabase.from("recommend") // 필요 시 'recommend_view'로 교체
    .select(`
      category,
      item,
      variety,
      labor_score,
      rarity_score,
      sow_start,
      harvest_end,
      profit_open,
      profit_greenhouse
    `);
    if (error) {
      console.error("❌ 데이터베이스 조회 오류:", error);
      throw error;
    }
    console.log(`📊 조회된 작물 데이터 수: ${cropsData?.length || 0}개`);
    // 데이터가 없으면 샘플 데이터 사용
    if (!cropsData || cropsData.length === 0) {
      console.log("⚠️ 데이터베이스에 데이터가 없어 샘플 데이터를 사용합니다.");
      // 샘플 데이터를 recommendation.ts에서 가져와서 사용
      const sampleData = [
        {
          "대분류": "콩_완두",
          "품목": "스냅피",
          "품종": "슈가앤",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "1월 초",
          "수확(종료) 시기": "4월 초",
          "수익성(노지)": 29700,
          "수익성(시설)": 31500
        },
        {
          "대분류": "콩_완두",
          "품목": "스냅피",
          "품종": "슈가레이스",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "1월 초",
          "수확(종료) 시기": "4월 중순",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_완두",
          "품목": "스냅피",
          "품종": "스시나인",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "1월 초",
          "수확(종료) 시기": "4월 중순",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_완두",
          "품목": "스냅피",
          "품종": "구르메",
          "노동편의성": 2,
          "품종희소성": 5,
          "파종(시작) 시기": "1월 초",
          "수확(종료) 시기": "4월 중순",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_완두",
          "품목": "스냅피",
          "품종": "슈가스냅",
          "노동편의성": 2,
          "품종희소성": 5,
          "파종(시작) 시기": "1월 초",
          "수확(종료) 시기": "4월 중순",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_채두",
          "품목": "그린빈",
          "품종": "칼리마",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "4월",
          "수확(종료) 시기": "8월",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_채두",
          "품목": "그린빈",
          "품종": "캐피타노",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "4월 초",
          "수확(종료) 시기": "6월 말",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_채두",
          "품목": "쉘빈",
          "품종": "드래곤빈",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "4월 초",
          "수확(종료) 시기": "6월 말",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_채두",
          "품목": "드라이빈",
          "품종": "비프빈",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "4월 초",
          "수확(종료) 시기": "6월 말",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_잠두",
          "품목": "풋잠두",
          "품종": "소라마메",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "10월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 5000,
          "수익성(시설)": 55100
        },
        {
          "대분류": "콩_잠두",
          "품목": "풋잠두",
          "품종": "브로드빈",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "10월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 5000,
          "수익성(시설)": 59700
        },
        {
          "대분류": "콩_강두",
          "품목": "롱빈",
          "품종": "샤사케",
          "노동편의성": 2,
          "품종희소성": 5,
          "파종(시작) 시기": "3월",
          "수확(종료) 시기": "6월",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_강두",
          "품목": "롱빈",
          "품종": "퍼스트레이디",
          "노동편의성": 2,
          "품종희소성": 4,
          "파종(시작) 시기": "3월",
          "수확(종료) 시기": "6월",
          "수익성(노지)": 69800,
          "수익성(시설)": 319500
        },
        {
          "대분류": "콩_대두",
          "품목": "풋콩",
          "품종": "차마메",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "4월 중순",
          "수확(종료) 시기": "8월 중순",
          "수익성(노지)": 596500,
          "수익성(시설)": 319500
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "피오레또",
          "노동편의성": 4,
          "품종희소성": 2,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 283550,
          "수익성(시설)": 629000
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "피오레또 퍼플",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 283650,
          "수익성(시설)": 718800
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "로마네스코",
          "노동편의성": 3,
          "품종희소성": 5,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 872500,
          "수익성(시설)": 629000
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "퍼플사파이어",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 872500,
          "수익성(시설)": 539100
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "오렌지사파이어",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 872500,
          "수익성(시설)": 539100
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "비타베르데",
          "노동편의성": 2,
          "품종희소성": 4,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 327850,
          "수익성(시설)": 584000
        },
        {
          "대분류": "음식꽃",
          "품목": "컬리플라워",
          "품종": "화이트",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월 말",
          "수익성(노지)": 523500,
          "수익성(시설)": 449200
        },
        {
          "대분류": "음식꽃",
          "품목": "브로콜리니",
          "품종": "탑스템(TopStem)",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "11월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 807075,
          "수익성(시설)": 119000
        },
        {
          "대분류": "음식꽃",
          "품목": "채화",
          "품종": "하바나",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 69800,
          "수익성(시설)": 798700
        },
        {
          "대분류": "음식꽃",
          "품목": "채화",
          "품종": "홍채",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 69800,
          "수익성(시설)": 798700
        },
        {
          "대분류": "음식꽃",
          "품목": "옥수수꽃",
          "품종": "초당옥수수",
          "노동편의성": 4,
          "품종희소성": 5,
          "파종(시작) 시기": "6월",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 174500,
          "수익성(시설)": 678900
        },
        {
          "대분류": "음식꽃",
          "품목": "호박",
          "품종": "호박꽃",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "5월 초",
          "수확(종료) 시기": "7월",
          "수익성(노지)": 69800,
          "수익성(시설)": 613400
        },
        {
          "대분류": "가지",
          "품목": "구이가지",
          "품종": "비올레타디시칠리아",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 509100,
          "수익성(시설)": 319500
        },
        {
          "대분류": "가지",
          "품목": "구이가지",
          "품종": "만쥬",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 511500,
          "수익성(시설)": 319500
        },
        {
          "대분류": "가지",
          "품목": "구이가지",
          "품종": "카모",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 511500,
          "수익성(시설)": 31900
        },
        {
          "대분류": "가지",
          "품목": "물가지",
          "품종": "샐러드가지",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 447400,
          "수익성(시설)": 239600
        },
        {
          "대분류": "가지",
          "품목": "물가지",
          "품종": "센슈키누카와",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 449600,
          "수익성(시설)": 239600
        },
        {
          "대분류": "가지",
          "품목": "물가지",
          "품종": "꿈의물방울",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 449600,
          "수익성(시설)": 239600
        },
        {
          "대분류": "가지",
          "품목": "물가지",
          "품종": "물의정원",
          "노동편의성": 3,
          "품종희소성": 5,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 449600,
          "수익성(시설)": 239600
        },
        {
          "대분류": "가지",
          "품목": "물가지",
          "품종": "페어리테일",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "12월 말",
          "수확(종료) 시기": "10월",
          "수익성(노지)": 449600,
          "수익성(시설)": 239600
        },
        {
          "대분류": "무",
          "품목": "보라무",
          "품종": "보라킹",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 90000,
          "수익성(시설)": 396400
        },
        {
          "대분류": "무",
          "품목": "보라무",
          "품종": "보라남",
          "노동편의성": 2,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 70100,
          "수익성(시설)": 317200
        },
        {
          "대분류": "무",
          "품목": "분홍무",
          "품종": "루비킹",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "8월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 69800,
          "수익성(시설)": 392000
        },
        {
          "대분류": "무",
          "품목": "속빨강무",
          "품종": "과일무",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "8월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 69800,
          "수익성(시설)": 465000
        },
        {
          "대분류": "무",
          "품목": "빨강무",
          "품종": "아르테시아",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "8월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 69800,
          "수익성(시설)": 397600
        },
        {
          "대분류": "무",
          "품목": "녹색무",
          "품종": "비타민무",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "8월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 69800,
          "수익성(시설)": 239600
        },
        {
          "대분류": "무",
          "품목": "순무",
          "품종": "흰순무",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 69800,
          "수익성(시설)": 239600
        },
        {
          "대분류": "무",
          "품목": "순무",
          "품종": "빨강순무",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 449600,
          "수익성(시설)": 239600
        },
        {
          "대분류": "무",
          "품목": "순무",
          "품종": "복숭아순무",
          "노동편의성": 4,
          "품종희소성": 2,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "4월",
          "수익성(노지)": 449600,
          "수익성(시설)": 239600
        },
        {
          "대분류": "배추",
          "품목": "결구배추",
          "품종": "속노랑",
          "노동편의성": 4,
          "품종희소성": 2,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 69800,
          "수익성(시설)": 355500
        },
        {
          "대분류": "배추",
          "품목": "빨강배추",
          "품종": "권농빨강3호",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 69800,
          "수익성(시설)": 392000
        },
        {
          "대분류": "배추",
          "품목": "결구배추",
          "품종": "개성",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 136800,
          "수익성(시설)": 513500
        },
        {
          "대분류": "배추",
          "품목": "양배추",
          "품종": "카라플렉스",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 83500,
          "수익성(시설)": 322900
        },
        {
          "대분류": "배추",
          "품목": "양배추",
          "품종": "알코사",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 83500,
          "수익성(시설)": 322900
        },
        {
          "대분류": "배추",
          "품목": "양배추",
          "품종": "티아라",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 62000,
          "수익성(시설)": 239800
        },
        {
          "대분류": "배추",
          "품목": "양배추",
          "품종": "꼬꼬마",
          "노동편의성": 4,
          "품종희소성": 2,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 58300,
          "수익성(시설)": 225100
        },
        {
          "대분류": "배추",
          "품목": "양배추",
          "품종": "레드블레임",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 83500,
          "수익성(시설)": 322900
        },
        {
          "대분류": "배추",
          "품목": "콜라비",
          "품종": "그린",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 71400,
          "수익성(시설)": 275800
        },
        {
          "대분류": "배추",
          "품목": "콜라비",
          "품종": "화이트",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "9월",
          "수확(종료) 시기": "3월",
          "수익성(노지)": 67000,
          "수익성(시설)": 259200
        },
        {
          "대분류": "당근",
          "품목": "오렌지",
          "품종": "모큼",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "2월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 71600,
          "수익성(시설)": 276800
        },
        {
          "대분류": "당근",
          "품목": "퍼플",
          "품종": "딥퍼플",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "2월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 65600,
          "수익성(시설)": 253800
        },
        {
          "대분류": "당근",
          "품목": "골드",
          "품종": "골드너겟",
          "노동편의성": 3,
          "품종희소성": 3,
          "파종(시작) 시기": "2월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 68000,
          "수익성(시설)": 263000
        },
        {
          "대분류": "당근",
          "품목": "레드",
          "품종": "긴토킨니진",
          "노동편의성": 2,
          "품종희소성": 5,
          "파종(시작) 시기": "2월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 65600,
          "수익성(시설)": 253800
        },
        {
          "대분류": "당근",
          "품목": "화이트",
          "품종": "화이트샤인",
          "노동편의성": 3,
          "품종희소성": 4,
          "파종(시작) 시기": "2월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 63200,
          "수익성(시설)": 244500
        },
        {
          "대분류": "-",
          "품목": "비트",
          "품종": "레드",
          "노동편의성": 4,
          "품종희소성": 3,
          "파종(시작) 시기": "3월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 69800,
          "수익성(시설)": 239600
        },
        {
          "대분류": "-",
          "품목": "비트",
          "품종": "골드",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "3월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 69800,
          "수익성(시설)": 239600
        },
        {
          "대분류": "-",
          "품목": "비트",
          "품종": "타겟",
          "노동편의성": 4,
          "품종희소성": 4,
          "파종(시작) 시기": "3월",
          "수확(종료) 시기": "5월",
          "수익성(노지)": 69800,
          "수익성(시설)": 239600
        }
      ];
      cropsData = sampleData;
    }
    // --- 추천 엔진 실행 ---
    const engine = new CropRecommendationEngine();
    let result;
    if (engine && typeof engine.run === "function") {
      // run(payload) 시그니처 지원
      result = await engine.run({
        start_month,
        end_month,
        place,
        irang,
        cropsData
      });
    } else if (engine && typeof engine.recommendCrops === "function") {
      // recommendCrops(...) 시그니처 지원
      result = await engine.recommendCrops(start_month, end_month, place, irang, cropsData);
    } else {
      throw new Error("CropRecommendationEngine에 run 또는 recommendCrops 메서드가 없습니다.");
    }
    return json({
      ok: true,
      result
    });
  } catch (err) {
    return json({
      error: String(err?.message ?? err ?? "Unknown error")
    }, {
      status: 500
    });
  }
});

