# PRD: 캘린더 및 작업 관리 개선사항

## 1. 개요

### 1.1 목적
FarmMate 애플리케이션의 캘린더 표시 및 작업 관리 기능을 개선하여 사용자 경험을 향상시키고 데이터 일관성을 보장합니다.

### 1.2 배경
기존 시스템에서 발견된 여러 문제점들을 해결하여 더 직관적이고 안정적인 농장 관리 시스템을 구축합니다.

## 2. 문제 정의

### 2.1 농작업 순서 문제
- **문제**: 파종, 육묘, 수확 작업을 선택할 때 순서가 보장되지 않음
- **영향**: 사용자가 의도한 농작업 순서와 다르게 표시됨

### 2.2 작물 선택 UI 문제
- **문제**: 작물 등록 시 검색창으로만 작물을 선택할 수 있음
- **영향**: 사용자가 작물을 찾기 어려움

### 2.3 파종 종료일 수정 문제
- **문제**: 파종 종료일을 수정하면 연속 박스가 끊어짐
- **영향**: 캘린더에서 작업의 연속성이 시각적으로 표현되지 않음

### 2.4 작업 등록 범위 문제
- **문제**: 홈화면에서 작업 등록 시 모든 날짜에 작업이 등록됨
- **영향**: 불필요한 작업이 생성됨

### 2.5 홈화면 표시 문제
- **문제**: 홈화면의 투두리스트와 일정에 캘린더용 작업이 표시됨
- **영향**: 사용자에게 혼란을 줌

### 2.6 연간 캘린더 박스 연결 문제
- **문제**: 연간 캘린더에서 월별로 끊어지는 박스가 이어지지 않음
- **영향**: 장기간 작업의 연속성이 시각적으로 표현되지 않음

### 2.7 날짜 범위 표시 문제
- **문제**: 달이 바뀔 때 "2025년"이 두 번 표시됨
- **영향**: 불필요한 중복 표시

### 2.8 일괄등록 작업 표시 문제
- **문제**: 홈화면에서 일괄등록된 작업이 개별 작업으로만 표시됨
- **영향**: 전체 재배 기간을 한눈에 볼 수 없음

### 2.9 UUID 오류 문제
- **문제**: 작업 수정 시 UUID 필드에 undefined 값이 전달되어 오류 발생
- **영향**: 작업 수정이 실패함

## 3. 해결 방안

### 3.1 농작업 순서 보장 ✅ 완료
**구현 방법**:
- 작업 선택 시 자동 정렬 로직 추가
- 파종 → 육묘 → 수확 순서 강제 적용

**적용 파일**:
- `batch-task-edit-dialog.tsx`
- `work-calculator-dialog.tsx`
- `add-task-dialog-improved.tsx`

**구현 완료**: 2025년 10월

### 3.2 작물 선택 UI 개선
**구현 방법**:
- 작물 리스트를 기본적으로 펼쳐진 상태로 표시
- 검색창과 작물 리스트를 동시에 제공

**적용 파일**:
- `add-task-dialog-improved.tsx`

### 3.3 연속 박스 표시 개선
**구현 방법**:
- taskGroupId가 있는 작업들은 무조건 연속 박스로 표시
- endDate를 고려하여 전체 날짜 범위 계산

**적용 파일**:
- `calendar.utils.ts`
- `batch-task-edit-dialog.tsx`

### 3.4 작업 등록 범위 제한
**구현 방법**:
- 개별등록 모드에서 날짜 범위를 지정하면 하나의 작업만 생성
- 파종, 육묘, 수확 기간에만 해당 작업 등록

**적용 파일**:
- `new-add-task-dialog.tsx`

### 3.5 홈화면 필터링
**구현 방법**:
- "재배" 유형의 작업은 캘린더에만 표시
- 홈화면의 투두리스트와 일정에서는 제외

**적용 파일**:
- `HomePage.tsx`

### 3.6 연간 캘린더 박스 연결
**구현 방법**:
- 하나의 연속된 박스로 표시
- 각 월의 위치에 맞게 날짜 표시
- 시작 월: `10/17~`, 중간 월: `11월`, 종료 월: `~12/18`

**적용 파일**:
- `farm-calendar-grid.tsx`

### 3.7 날짜 범위 표시 개선
**구현 방법**:
- 같은 년도일 때: `"2025년 11월 30일 - 12월 10일"`
- 다른 년도일 때: `"2025년 11월 30일 - 2026년 1월 10일"`

**적용 파일**:
- `HomePage.tsx`

### 3.8 일괄등록 작업 그룹화
**구현 방법**:
- taskGroupId가 같은 작업들을 하나의 그룹으로 묶어서 표시
- 그룹의 전체 날짜 범위 계산
- 작물명과 작업 순서 표시 (파종 → 육묘 → 수확)

**적용 파일**:
- `HomePage.tsx`
- `todo-list.tsx`

### 3.9 UUID 오류 해결
**구현 방법**:
- undefined 값을 null로 변환
- farmId와 cropId는 유효한 UUID일 때만 포함

**적용 파일**:
- `tasks.ts`
- `batch-task-edit-dialog.tsx`

## 4. 기술적 구현 세부사항

### 4.1 농작업 순서 정렬
```typescript
const taskOrder = ["파종", "육묘", "수확"];
return newTasks.sort((a, b) => {
  const indexA = taskOrder.indexOf(a);
  const indexB = taskOrder.indexOf(b);
  return indexA - indexB;
});
```

### 4.2 연속 박스 날짜 범위 계산
```typescript
const allDates: Date[] = [];
groupTasks.forEach(t => {
  allDates.push(new Date(t.scheduledDate));
  if (t.endDate) {
    allDates.push(new Date(t.endDate));
  }
});
const startDate = new Date(Math.min(...allDates.map(d => d.getTime())));
const endDate = new Date(Math.max(...allDates.map(d => d.getTime())));
```

### 4.3 UUID 검증 로직
```typescript
if (taskData.farmId && taskData.farmId !== 'undefined' && taskData.farmId !== '') {
  updateData.farm_id = taskData.farmId;
} else {
  updateData.farm_id = null;
}
```

## 5. 테스트 시나리오

### 5.1 농작업 순서 테스트
1. 작업 등록 시 파종, 육묘, 수확을 선택
2. 자동으로 파종 → 육묘 → 수확 순서로 정렬되는지 확인

### 5.2 연간 캘린더 테스트
1. 10월부터 12월까지의 작업 등록
2. 연간 캘린더에서 하나의 연속된 박스로 표시되는지 확인
3. 각 월에 올바른 날짜가 표시되는지 확인

### 5.3 홈화면 그룹화 테스트
1. 일괄등록된 작업을 홈화면에서 확인
2. 그룹화되어 표시되는지 확인
3. 클릭 시 일괄 수정 다이얼로그가 열리는지 확인

### 5.4 UUID 오류 테스트
1. 작업 수정 시 undefined 값이 전달되는 경우
2. 오류 없이 수정되는지 확인

## 6. 성공 지표

### 6.1 사용자 경험 개선
- 농작업 순서가 직관적으로 표시됨
- 연간 캘린더에서 장기간 작업의 연속성이 명확히 표현됨
- 홈화면에서 일괄등록된 작업을 한눈에 파악 가능

### 6.2 기술적 안정성
- UUID 관련 오류 0건
- 작업 수정 성공률 100%
- 캘린더 박스 표시 정확도 100%

### 6.3 데이터 일관성
- 작업 등록 시 불필요한 중복 작업 생성 방지
- 홈화면과 캘린더 간 데이터 표시 일관성 확보

## 7. 향후 개선사항

### 7.1 성능 최적화
- 대량 작업 처리 시 성능 개선
- 캘린더 렌더링 최적화

### 7.2 사용자 경험 개선
- 드래그 앤 드롭으로 작업 순서 변경
- 키보드 단축키 지원

### 7.3 데이터 분석
- 작업 완료율 통계
- 재배 기간 분석

## 8. 결론

이번 개선사항을 통해 FarmMate 애플리케이션의 캘린더 표시 및 작업 관리 기능이 크게 향상되었습니다. 사용자는 더 직관적이고 안정적인 농장 관리 시스템을 경험할 수 있게 되었으며, 데이터 일관성과 시각적 표현이 개선되었습니다.

---

## 9. 최근 업데이트 (2025년 10월 19일)

### 9.1 추가 개선사항
- ✅ **일괄등록 삭제 버튼 추가**: 취소 버튼을 삭제 버튼으로 변경하여 UX 개선
- ✅ **일괄등록 수정 반영 버그 수정**: 작업 수정 시 변경사항이 즉시 반영되도록 수정
- ✅ **농작업 계산기 날짜 조정**: 자동 생성된 날짜를 세부적으로 수동 조정 가능하도록 개선
- ✅ **작물 추천 정렬 개선**: 점수 동일 시 예상 매출액 기준 2차 정렬 추가
- ✅ **UI 일관성 개선**: 불필요한 max-w-md 제거로 화면 공간 효율적 활용
- ✅ **연간 캘린더 버그 수정**: 연간 뷰 표시 오류 해결

### 9.2 관련 PR
- #46: 일괄등록 개선 (삭제 버튼 추가, 수정 반영 버그 수정, 날짜 조정 기능)
- #44: 농작업 계산기 로직 재수정
- #43, #42, #41: Vercel 배포 환경 최적화
- #40: 연간 캘린더 문제 해결
- #38: 캘린더 CSV Export 기능 추가

### 9.3 영향받는 컴포넌트
- `batch-task-edit-dialog.tsx`: 삭제 버튼 및 수정 로직 개선
- `work-calculator-dialog.tsx`: 세부 날짜 조정 기능 추가 (142줄 추가)
- `supabase/functions/recommend/`: 추천 정렬 로직 개선
- `layout/header.tsx`, `layout/mobile-nav.tsx`: UI 일관성 개선
- `calendar-grid.tsx`: 연간 캘린더 렌더링 수정
