[PRD] FarmMate: 통합 장부(매출/비용) 및 농작업 연동 시스템
1. 프로젝트 개요
배경: 기존 '농작업 관리'는 기록 중심의 데이터이나, '장부'는 작업 결과(수익/지출) 중심의 데이터임. 두 데이터의 성격 차이를 반영하여 입력 시점을 분리하되, 데이터 연동을 통해 대시보드용 경영 데이터를 확보하고자 함.

목적: 작업 전/중 기록(일지)과 작업 후 결과(장부)의 유기적 연결을 통한 농장 경영 가시성 확보.

핵심 지표: 장부 등록률, 작물별/이랑별 ROI(수익률) 데이터 확보.

2. 유저 플로우 (User Flow)
Flow 1. 캘린더 기반 작업 직후 기록 (직관적 관리)
- [x] 진입: 캘린더 뷰 내 등록된 '일지 박스' 클릭.

- [x] 분기(Action Sheet): 하단 선택 팝업 노출.

- [x] 옵션 A: [📝 일지 내용 수정] → 기존 농작업 수정 페이지로 이동.

- [x] 옵션 B: [💰 장부 내역 작성] → '장부 작성 모달' 호출.

- [x] 자동화: 일지 데이터(날짜, 작물, 작업명 등)가 모달 내 읽기 전용 영역에 자동 바인딩.

- [x] 저장 후 이동: 장부 저장 완료 시 마이페이지-장부 관리 리스트 페이지로 이동.

Flow 2. 마이페이지 기반 사후 일괄 관리 (회고적 관리)
- [x] 진입: 마이페이지 > [📖 장부 관리] 버튼 클릭.

리스트 뷰:

- [x] 필터: 기간 선택(연/월 선택), 상태 필터(전체/장부 미등록).

- [x] 정렬: 장부 미등록 건을 최상단에 우선 배치.

- [x] 상태 표시: 미등록(빨간색 배지), 등록 완료(회색 배지).

- [x] 실행: 리스트 아이템 클릭 시 '장부 작성 모달' 호출.

3. 기능 요구사항 (Functional Requirements)
3.1 장부 작성 모달 (Common Modal)
- [x] Flow 1, 2 공통으로 사용하며, 일지 데이터와 장부 데이터를 1:1 또는 1:N으로 매핑함.

A. 읽기 전용 영역 (Context Header)
- [x] 내용: 날짜, 이랑 번호, 농장명, 작물명, 작업 내용.

- [x] UI: 상단 회색 박스 고정 노출 (수정 불가).

B. 매출 입력 영역 (Revenue Section)
- [x] 수확량: 숫자 입력 필드 + 단위 선택 드롭다운 (kg, g, box, 포대, 근 등).

- [x] 품질: 세그먼트 버튼 선택 (최상 / 상 / 중 / 하).

- [x] 판매처: 텍스트 입력 필드.

- [x] 총 매출액: 숫자 입력 필드 (단위: 원) - 입력 시 천 단위 구분자(,) 자동 표시.

- [x] 수익 계산: 총 매출액과 총 비용을 입력하면 자동으로 수익(매출-비용) 계산 및 표시.

C. 비용 입력 영역 (Expense Section)
- [x] 총 비용: 입력된 세부 카테고리 비용의 합계 자동 계산.

- [x] 세부 카테고리 관리 (동적 추가 방식):

- [x] [+ 비용 카테고리 추가] 버튼 제공.

- [x] 선택 리스트: 종자/묘목비, 비료/퇴비, 농약/방제비, 인건비(외부인력), 자재비(비닐, 지주대 등), 기계/유류비, 기타 등.

- [x] 기타 카테고리: '기타' 선택 시 텍스트 입력 필드가 나타나 사용자가 직접 카테고리명 입력 가능.

- [x] 입력 구조: [카테고리 선택(드롭다운)] : [금액 입력(원)] 형태의 Row가 추가됨.

- [x] 금액 입력: 천 단위 구분자(,) 자동 표시.

4. UI/UX 요구사항
- [x] 일관성: 팜메이트의 브랜드 컬러(Green)를 포인트 컬러로 활용하되, 미등록 상태 등 경고가 필요한 곳엔 빨간색 배지 활용.

- [x] 입력 편의성: 숫자 입력 시 숫자 키패드가 기본 활성화되도록 설정.

- [x] 반응형: 모바일 웹 환경에서 한 손 조작이 가능하도록 버튼 크기와 간격 최적화.

- [x] 금액 표시: 총 매출액, 비용 항목 금액 입력 시 천 단위 구분자(,) 자동 표시로 가독성 향상.

- [x] 수익 표시: 매출과 비용 입력 시 자동 계산된 수익을 명확하게 표시.

- [x] 기간 필터: 장부 관리 페이지의 기간 필터는 연/월만 선택 가능하도록 단순화 (날짜 선택 불필요).

5. 데이터 구조 (Data Schema - 참조용)
[tasks Table] (기존)
id: PK (varchar/UUID)

user_id: 사용자 FK (varchar)

scheduled_date: 날짜 (date)

crop_id: 작물 FK (varchar)

farm_id: 농장 FK (varchar)

task_type: 작업 종류 (text)

title: 작업 제목 (text)

description: 작업 설명 (text)

row_number: 이랑 번호 (integer)

created_at: 생성일시 (timestamp)

[ledgers Table] (신규)
id: PK (varchar/UUID)

user_id: 사용자 FK (varchar)

task_id: tasks 테이블 FK (varchar) - 연동 핵심

revenue_amount: 총 매출액 (integer)

harvest_quantity: 수확량 (integer)

harvest_unit: 수확 단위 (text) - kg, g, box, 포대, 근 등

quality_grade: 품질 등급 (text) - 최상, 상, 중, 하

sales_channel: 판매처 (text)

created_at: 생성일시 (timestamp)

updated_at: 수정일시 (timestamp)

[expense_items Table] (1:N 관계)
id: PK (varchar/UUID)

ledger_id: ledgers 테이블 FK (varchar)

category: 비용 카테고리명 (text) - 종자/묘목비, 비료/퇴비, 농약/방제비, 인건비(외부인력), 자재비(비닐, 지주대 등), 기계/유류비, 기타

cost: 해당 카테고리 비용 (integer)

created_at: 생성일시 (timestamp)

6. 향후 확장 계획
- [ ] 대시보드 연동: 입력된 장부 데이터를 바탕으로 홈 화면 상단에 '월별 손익 추이' 및 '작물별 수익성(ROI)' 차트 자동 업데이트.

- [ ] CSV 내보내기: 장부 관리 페이지 내 필터링된 데이터를 엑셀 파일로 추출하는 기능 추가.

---

## 7. 추가 요구사항 (상세)

### 7.1 마이페이지-장부 등록 기능
- [x] 총 매출액, 금액 기입할 때 천 단위 구분자(,)를 붙여서 단위값을 확실히 알 수 있게 표시
- [x] 총 매출, 비용 기입하면 매출-비용 해서 수익도 자동 계산하여 표시
- [x] 비용 카테고리에서 '기타'를 클릭하면 텍스트 입력 필드가 나타나 사용자가 직접 카테고리명을 입력할 수 있게 함
- [x] 기간 필터 영역에 연/월만 선택 가능하도록 단순화 (날짜 선택 제거)

### 7.2 캘린더-장부 등록 기능
- [x] 캘린더에서 작업 클릭 시 '일지 내용 수정', '장부 내역 작성' 선택란이 나오도록 구현
- [x] '일지 내용 수정' 클릭 시 원래처럼 일지 수정하는 플로우로 이동
- [x] '장부 내역 작성' 클릭 시 클릭한 그 작업에 해당하는 '장부 작성 플로우'로 이동
- [x] 장부 저장 완료 시 마이페이지-장부 관리 리스트 페이지로 자동 이동